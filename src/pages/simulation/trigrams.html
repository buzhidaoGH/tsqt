<!DOCTYPE html>
<html lang="zh_CN">
<head>
  <meta charset="UTF-8">
  <title>八卦和宝石</title>
  <style type="text/css">
    #trigrams {
      background-color: #FFEA7E;
      box-shadow: 0 0 10px #FE5A00;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    #jewels{
      background-color: #9B8CE9;
      box-shadow: 0 0 10px #FD7FE7;
      border-radius: 5px;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <!-- 乾坤八卦模拟 -->
  <div class="layui-col-xs12" id="trigrams">
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
      <legend>乾坤八卦提升</legend>
    </fieldset>
    <form class="layui-form">
      <!-- 武功选择参数 -->
      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">八卦类别</label>
          <div class="layui-input-inline" style="width: 80px;text-align: center">
            <select name="trigramsSelect" lay-verify="required" id="trigramsSelect"></select>
          </div>

          <label class="layui-form-label">初始阶级</label>
          <div class="layui-input-inline" style="width: 180px;text-align: center;text-align-last: center">
            <select name="startTrigramsLevel" lay-verify="required|trigramsVerify" id="startTrigramsLevel"
                    lay-search></select>
          </div>

          <label class="layui-form-label">目标阶级</label>
          <div class="layui-input-inline" style="width: 180px;text-align: center;text-align-last: center">
            <select name="endTrigramsLevel" lay-verify="required|trigramsVerify" id="endTrigramsLevel"
                    lay-search></select>
          </div>
        </div>
        <!-- 提交按钮 -->
        <div class="layui-form-item">
          <div class="layui-input-block">
            <button type="submit" class="layui-btn layui-btn-normal" lay-submit lay-filter="trigramsMock">模拟
            </button>
            <button type="reset" class="layui-btn layui-btn-danger" id="btnReset">重置</button>
          </div>
        </div>
      </div>
      <!-- 八卦消耗模拟 -->
      <div class="layui-form-item" id="trigrams_material_mock">
        <label class="layui-form-label">升级材料</label>
        <div class="layui-input-inline" style="text-align-last:center;width: 112px;text-align: center">
          <label class="layui-form-label" style="border: rgba(0,0,0,.85) 1px solid">空</label>
          <input type="text" readonly class="layui-input" value="空" style="padding: 0">
        </div>
      </div>
    </form>
  </div>

  <!-- 宝石模拟 -->
  <div class="layui-col-xs12" id="jewels">
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
      <legend>宝石模拟</legend>
    </fieldset>
    <form class="layui-form layui-form-pane">
      <!-- 宝石选择参数 -->
      <div class="layui-form-item">
        <div class="layui-form-item">
          <label class="layui-form-label">宝石类别</label>
          <div class="layui-input-inline" style="width: 110px;text-align: center;text-align-last: center">
            <select name="jewelsSelect" lay-verify="required">
              <option value="0" selected>天&ensp;寿&ensp;石</option>
              <option value="1">天&ensp;速&ensp;石</option>
              <option value="2">天勇|天损</option>
            </select>
          </div>

          <label class="layui-form-label">宝石等级</label>
          <div class="layui-input-inline" style="width: 80px;text-align: center;text-align-last: center">
            <select name="jewelsLevel" lay-verify="required">
              <option value="2" selected>三级</option>
              <option value="3">四级</option>
              <option value="4">五级</option>
              <option value="5">六级</option>
            </select>
          </div>

          <label class="layui-form-label">模拟个数</label>
          <div class="layui-input-inline" style="width: 80px;text-align: center;text-align-last: center">
            <input type="text" name="jewelsQuantity" class="layui-input" value="1"
                   lay-verify="required|number|jewelsVerify" style="padding: 0">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">人物角色</label>
          <div class="layui-input-inline" style="width: 80px;text-align: center;text-align-last: center">
            <select name="character" lay-verify="required">
              <option value="0" selected>术士</option>
              <option value="1">修真</option>
              <option value="2">侠客</option>
              <option value="3">刺客</option>
            </select>
          </div>

          <label class="layui-form-label">宝石品质</label>
          <div class="layui-input-inline" style="width: 80px;text-align: center;text-align-last: center">
            <select name="jewelsQuality" lay-verify="required">
              <option value="0" selected>基础</option>
              <option value="1">普通</option>
              <option value="2">无暇</option>
              <option value="3">完美</option>
            </select>
          </div>
        </div>
        <!-- 提交按钮 -->
        <div class="layui-form-item">
          <div class="layui-input-block">
            <button type="submit" class="layui-btn layui-btn-normal" lay-submit lay-filter="jewelsMock">模拟
            </button>
            <button type="reset" class="layui-btn layui-btn-danger" onclick="jewelsEnhance(0,{})">重置</button>
            <span style="color: #000000">PS:对结果进行了便捷化处理,舍弃了精度</span>
          </div>
        </div>
      </div>
      <!-- 属性加成模拟 -->
      <div class="layui-form-item" id="jewelsEnh">
        <div class="layui-form-item">
          <label class="layui-form-label">面板提升</label>
          <div class="layui-input-inline" style="text-align-last:center;width: 110px;text-align: center">
            <label class="layui-form-label" style="border: rgba(0,0,0,.85) 1px solid">空</label>
            <input type="text" readonly class="layui-input" value="空" style="padding: 0">
          </div>
        </div>
      </div>
    </form>
  </div>

  <script src="./assets/tool.js"></script>
  <script type="text/javascript">
    let trigrams, jewels
    let $trigrams_material_mock = $('#trigrams_material_mock')
    let $jewelsEnh = $('#jewelsEnh')
    $(function () {
      $('#btnReset').click(function () {
        $trigrams_material_mock.empty()
        $trigrams_material_mock.append(`
        <label class="layui-form-label">升级材料</label>
        <div class="layui-input-inline" style="text-align-last:center;width: 112px;text-align: center">
          <label class="layui-form-label" style="border: rgba(0,0,0,.85) 1px solid">空</label>
          <input type="text" readonly class="layui-input" value="空" style="padding: 0">
        </div>
        `)
      })
    })
    layui.use(['form', 'layer'], function () {
      let form = layui.form, layer = layui.layer
      // 规则
      form.verify({
        trigramsVerify: function (value) {
          let start = parseInt($('#startTrigramsLevel').val())
          let end = parseInt($('#endTrigramsLevel').val())
          if (start > end) {
            return "初始阶级不能大于目标阶级"
          }
        },
        jewelsVerify: function (value) {
          if (value <= 0 || value > 120) {
            return "宝石数量不符合逻辑"
          }
        }
      })
      // 请求基础数据
      fetch("./assets/db/base.json").then(res => res.json()).then(function ({trigramsList}) {
        let $trigramsSelect = $('#trigramsSelect')
        for (let i = 0; i < trigramsList.length; i++) {
          $trigramsSelect.append(`<option value="${ i }">${ trigramsList[i] }</option>`)
        }
        form.render("select")
      })
      // 请求八卦数据
      fetch("./assets/db/jewels").then(res => res.text()).then(data => {
        let $startTrigramsLevel = $('#startTrigramsLevel')
        let $endTrigramsLevel = $('#endTrigramsLevel')
        trigrams = JSON.parse(decrypt(data)).trigrams
        jewels = JSON.parse(decrypt(data)).jewels
        for (let i = 0; i < trigrams.name.length; i++) {
          if (i === 0) {
            $startTrigramsLevel.append(`<option value="${ i }" selected>${ trigrams.name[i] }</option>`)
          } else {
            $startTrigramsLevel.append(`<option value="${ i }">${ trigrams.name[i] }</option>`)
          }
          if (i === trigrams.name.length - 1) {
            $endTrigramsLevel.append(`<option value="${ i }" selected>${ trigrams.name[i] }</option>`)
          } else {
            $endTrigramsLevel.append(`<option value="${ i }">${ trigrams.name[i] }</option>`)
          }
        }
        form.render("select")
      })

      // 模拟八卦提交
      form.on('submit(trigramsMock)',
          function ({field: {trigramsSelect, startTrigramsLevel, endTrigramsLevel}}) {
            const materialMap = trigramsMaterial(trigramsSelect, startTrigramsLevel, endTrigramsLevel)
            $trigrams_material_mock.empty()
            $trigrams_material_mock.append(`<label class="layui-form-label">升级材料</label>`)
            $trigrams_material_mock.append(`
            <div class="layui-input-inline" style="text-align-last:center;width: 112px;text-align: center">
              <label class="layui-form-label" style="border: rgba(0,0,0,.85) 1px solid">暗淡的${ materialMap.type }</label>
              <input type="text" readonly class="layui-input" value="${ materialMap.bleak }" style="padding: 0">
            </div>
            `)
            $trigrams_material_mock.append(`
            <div class="layui-input-inline" style="text-align-last:center;width: 112px;text-align: center">
              <label class="layui-form-label" style="border: rgba(0,0,0,.85) 1px solid">明亮的${ materialMap.type }</label>
              <input type="text" readonly class="layui-input" value="${ materialMap.bright }" style="padding: 0">
            </div>
            `)
            $trigrams_material_mock.append(`
            <div class="layui-input-inline" style="text-align-last:center;width: 112px;text-align: center">
              <label class="layui-form-label" style="border: rgba(0,0,0,.85) 1px solid">闪耀的${ materialMap.type }</label>
              <input type="text" readonly class="layui-input" value="${ materialMap.shine }" style="padding: 0">
            </div>
            `)
            return false
          }
      )
      // 宝石模拟属性
      form.on('submit(jewelsMock)',
          function ({field: {jewelsQuality, jewelsSelect, jewelsLevel, jewelsQuantity, character}}) {
            const jewelsInfoList = jewelsInfo(
                parseInt(jewelsQuality), parseInt(jewelsSelect),
                parseInt(jewelsLevel), parseInt(jewelsQuantity), parseInt(character)
            )
            // 获取的数据进行双词遍历,且使用Match.round();四舍五入
            // console.log(jewelsInfoList)
            jewelsEnhance(1, jewelsInfoList)
            return false
          }
      )
    })

    // 八卦材料数据生成
    function trigramsMaterial(trigramsSelect, startTrigramsLevel, endTrigramsLevel) {
      trigramsSelect = parseInt(trigramsSelect)
      startTrigramsLevel = parseInt(startTrigramsLevel)
      endTrigramsLevel = parseInt(endTrigramsLevel)

      function handle(level) {
        const result = {
          bleak: 0,
          bright: 0,
          shine: 0
        }
        if (level < 19) {
          result.bleak = sum(0, level)
        }
        if (level >= 19 && level < 37) {
          result.bleak = sum(0, 18)
          result.bright = sum(19, level)

        }
        if (level >= 37 && level < 54) {
          result.bleak = sum(0, 18)
          result.bright = sum(19, 36)
          result.shine = sum(37, level)
        }

        function sum(star, end) {
          let sun = 0
          for (let i = star; i < end + 1; i++) {
            sun += trigrams.materials[i]
          }
          return sun
        }

        return result
      }

      let start = handle(startTrigramsLevel)
      let end = handle(endTrigramsLevel)

      const result = {
        type: "无",
        bleak: end.bleak - start.bleak,
        bright: end.bright - start.bright,
        shine: end.shine - start.shine
      }
      trigramsSelect < 3 ? result.type = "青龙"
          : trigramsSelect < 5 ? result.type = "玄武"
          : trigramsSelect < 7 ? result.type = "白虎"
              : trigramsSelect < 9 ? result.type = "朱雀"
                  : ''
      return result
    }

    // 宝石模拟
    function jewelsInfo(quality, select, level, quantity, character) {
      let jewelsBase = 0
      const nameList = [], valList = []

      function handle(type, base, name, quan) {
        let list = [0, 0, 0, 0]
        switch (name) {
          case "wushan": {
            list = [0.5, 1, 1, 1.88]
            break
          }
          case "wubao": {
            list = [1.5, 2.25, 3.5, 5]
            break
          }
          case "wumin": {
            list = [25, 18, 27, 21.6]
            break
          }
        }
        return list[type] * base * quan
      }

      switch (select) {
        case 0: { // 天寿
          jewelsBase = jewels.pink[level][quality]
          nameList.push(...["血量", "法量", "怒气", "速度", "恢复", "物攻|物防"])
          valList.push(...[
            jewelsBase * 24 * quantity, jewelsBase * 1 * quantity, jewelsBase * 8 * quantity,
            jewelsBase * 0.2 * quantity, jewelsBase * 0.8 * quantity, jewelsBase * 0.1 * quantity
          ])
          break
        }
        case 1: { // 天速
          jewelsBase = jewels.pink[level][quality]
          nameList.push(...["速度", "血量", "法量|怒气", "恢复", "物攻|物防", "物闪", "物爆", "物命"])
          valList.push(...[
            jewelsBase * 2 * quantity, jewelsBase * 3 * quantity, jewelsBase * 2 * quantity,
            jewelsBase * 0.2 * quantity, jewelsBase * 0.2 * quantity,
            handle(character, jewelsBase, "wushan", quantity),
            handle(character, jewelsBase, "wubao", quantity),
            handle(character, jewelsBase, "wumin", quantity)
          ])
          break
        }
        case 2: { // 紫色|天损|天勇
          jewelsBase = jewels.lilac[level][quality]
          nameList.push(...["攻击"])
          valList.push(...[jewelsBase * quantity])
          break
        }
      }
      return {nameList, valList}
    }

    // 面板提升
    function jewelsEnhance(flag, {nameList, valList}) {
      $jewelsEnh.empty()
      let $temp = $(`<div class="layui-form-item"></div>`)
      let $temp2 = $(`<div class="layui-form-item"></div>`)
      $temp.append(`<label class="layui-form-label">面板提升</label>`)
      $temp2.append(`<label class="layui-form-label">&emsp;</label>`)
      if (flag === 0) {
        $temp.append(`<div class="layui-input-inline" style="text-align-last:center;width: 110px;text-align: center">
          <label class="layui-form-label" style="border: rgba(0,0,0,.85) 1px solid">空</label>
          <input type="text" readonly class="layui-input" value="空" style="padding: 0">
        </div>`)
      } else {
        for (let i = 0; i < nameList.length; i++) {
          if (i < 5) {
            $temp.append(`
              <div class="layui-input-inline" style="text-align-last:center;width: 110px;text-align: center">
                <label class="layui-form-label" style="border: rgba(0,0,0,.85) 1px solid">${ nameList[i] }</label>
                <input type="text" readonly class="layui-input" value="${ Math.round(valList[i]) }" style="padding: 0">
              </div>
              `)
          } else {
            $temp2.append(`
              <div class="layui-input-inline" style="text-align-last:center;width: 110px;text-align: center">
                <label class="layui-form-label" style="border: rgba(0,0,0,.85) 1px solid">${ nameList[i] }</label>
                <input type="text" readonly class="layui-input" value="${ Math.round(valList[i]) }" style="padding: 0">
              </div>
            `)
          }
        }
      }
      $jewelsEnh.append($temp)
      nameList.length > 5 ? $jewelsEnh.append($temp2) : ''
    }
  </script>
</body>
</html>